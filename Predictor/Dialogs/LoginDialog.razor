@using Predictor.Authentication
@inject IUserAccess userAccess
@inject NavigationManager navigation

<MudDialog>
	<TitleContent>
		<MudText Typo="@Typo.h6">
			<MudIcon Icon="@Icons.Filled.Login" Class="mr-3 mb-n1" />
			Login
		</MudText>
	</TitleContent>
	<DialogContent>
		<MudTextField @bind-Value="LoginText" Label="Login" Variant="Variant.Outlined" Adornment="Adornment.End" AdornmentIcon="@IconDanger" AdornmentColor="Color.Secondary" />
		<MudTextField @bind-Value="PasswordText"  Label="Password" Variant="Variant.Outlined" InputType="InputType.Password" Adornment="Adornment.End" AdornmentIcon="@IconDanger" AdornmentColor="Color.Secondary" />
	</DialogContent>
	<DialogActions>
		<MudButton OnClick="Cancel" Color="Color.Error">Cancel</MudButton>
		<MudButton OnClick="Login" Color="Color.Secondary">Login</MudButton>
	</DialogActions>
</MudDialog>

@code {
	[CascadingParameter] MudDialogInstance MudDialog { get; set; }

	public string LoginText { get; set; } = string.Empty;
	public string PasswordText { get; set; } = string.Empty;
	private string IconDanger { get; set; } = "";

	private void Cancel()
	{
		MudDialog.Cancel();
	}

	private void IconDangerReset()
	{
		IconDanger = string.Empty;
	}

	private async Task Login()
	{
		var userAccount = await userAccess.GetByLoginAsync(LoginText);

		if (userAccount is null || userAccount.Password != PasswordText)
		{
			IconDanger = Icons.TwoTone.Dangerous;
			//await Task.Delay(3000);
			//IconDanger = "";
		}
		else
		{
			//var customAuthStateProvider = (CustomAuthenticationStateProvider)authStateProvider;
			//await customAuthStateProvider.UpdateAuthenticationStateAsync(new UserSession
			//	{
			//		UserName = userAccount.FirstName,
			//		Role = userAccount.UserRole.Value

			//	});
			MudDialog.Close(DialogResult.Ok(new UserSession
				{
					UserName = userAccount.FirstName,
					Role = userAccount.UserRole.Value
				}));
			navigation.NavigateTo("/", true);
		}
	}
}
